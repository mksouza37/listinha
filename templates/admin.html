<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Listinha Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#f7f7f8; color:#111; }
    .container { max-width: 900px; margin: 24px auto; background: #fff; border-radius: 14px; box-shadow: 0 2px 10px rgba(0,0,0,.06); padding: 24px; }
    h1 { font-size: 20px; margin: 0 0 16px; }
    h2 { font-size: 18px; margin-top: 28px; border-top: 1px solid #eee; padding-top: 16px; }
    form { display:flex; gap:8px; margin-bottom:16px; }
    input[type=text], input[type=number] { padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
    input[type=text] { flex:1; }
    button { padding:10px 14px; border:0; border-radius:10px; background:#111; color:#fff; font-weight:600; cursor:pointer; }
    .muted { color:#666; font-size: 12px; }
    .row { display:grid; grid-template-columns: 240px 1fr; gap:8px; padding:8px 0; border-bottom:1px dashed #eee; }
    .row b { color:#333; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#f1f1f3; }
    .ok { background:#e8f7ee; color:#126b3e; }
    .warn { background:#fff7e5; color:#8a5b00; }
    .danger { background:#ffefef; color:#8a1e1e; }
    a { color: #0969da; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .raw { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; background:#fafafa; border:1px solid #eee; padding:12px; border-radius:10px; }
    .err { color:#8a1e1e; background:#ffefef; padding:10px 12px; border-radius:10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Listinha Admin</h1>

    <form method="post" action="/admin/lookup">
      <input type="text" name="owner_phone" value="{{ query }}" placeholder="+55 11 98888-8888" />
      <button type="submit">Lookup</button>
    </form>

    {% if error %}
      <div class="err">{{ error }}</div>
    {% endif %}

    {% if result %}
      <h2>Owner</h2>
      <div class="row"><b>Phone (doc id)</b><div class="badge">{{ result.doc_id }}</div></div>
      <div class="row"><b>Name</b><div>{{ result.name or "-" }}</div></div>
      <div class="row"><b>List Role</b><div>{{ result.group_role or "-" }} <span class="muted">(Dono/Convidado)</span></div></div>

      <h2>List Context</h2>
      <div class="row"><b>Instance</b><div>{{ result.group_instance or "-" }}</div></div>
      <div class="row"><b>Owner</b><div>{{ result.group_owner or "-" }}</div></div>
      <div class="row"><b>List</b><div>{{ result.group_list or "-" }}</div></div>

      <h2>Billing</h2>
      {% set s = result %}
      {% set stat = (s.billing_state_pt or s.billing_state or "-") %}
      {% set badge_cls = "badge" %}
      {% if s.billing_state == "ACTIVE" or s.billing_state == "TRIAL" or s.billing_state == "GRACE" or s.billing_state == "LIFETIME" %}
        {% set badge_cls = "badge ok" %}
      {% elif s.billing_state == "PAST_DUE" %}
        {% set badge_cls = "badge warn" %}
      {% elif s.billing_state == "CANCELED" or s.billing_state == "EXPIRED" %}
        {% set badge_cls = "badge danger" %}
      {% endif %}

      <div class="row"><b>Status (computado)</b><div><span class="{{ badge_cls }}">{{ stat }}</span></div></div>
      <div class="row"><b>Válida até (computado)</b><div>{{ s.billing_until_fmt }}</div></div>

      <div class="row"><b>Stripe status (bruto)</b><div>{{ s.stripe_status or "-" }}</div></div>
      <div class="row"><b>Período atual até</b><div>{{ s.current_period_end_fmt }}</div></div>
      <div class="row"><b>Fim do teste</b><div>{{ s.trial_end_fmt }}</div></div>
      <div class="row"><b>Carência até</b><div>{{ s.grace_until_fmt }}</div></div>

      <div class="row"><b>Cancelamento agendado?</b><div>{{ "Sim" if s.cancel_at_period_end else "Não" }}</div></div>
      <div class="row"><b>Cancelamento em</b><div>{{ s.cancel_at_fmt }}</div></div>
      <div class="row"><b>Cancelado agora?</b><div>{{ "Sim" if s.canceled else "Não" }}</div></div>
      <div class="row"><b>Cancelado em</b><div>{{ s.canceled_at_fmt }}</div></div>

      <div class="row"><b>Subscription ID</b><div>{{ s.subscription_id or "-" }}</div></div>
      <div class="row"><b>Customer ID</b><div>{{ s.stripe_customer_id or "-" }}</div></div>
      <div class="row"><b>Last Event ID</b><div>{{ s.last_event_id or "-" }}</div></div>
      <div class="row"><b>Último link de Checkout</b>
        <div>
          {% if s.last_checkout_url %}
            <a href="{{ s.last_checkout_url }}" target="_blank" rel="noopener">Abrir</a>
          {% else %}-{% endif %}
        </div>
      </div>

      <!-- Admin Actions -->
      <h2>Ações de Assinatura (Admin)</h2>

      <form method="post" action="/admin/extend_trial" style="display:flex; gap:8px; align-items:center; margin: 6px 0 12px;">
        <input type="hidden" name="owner_phone" value="{{ result.doc_id }}"/>
        <label for="days"><b>Adicionar dias ao próximo vencimento</b></label>
        <input type="number" min="1" step="1" name="days" id="days" placeholder="Ex.: 30" style="width:140px;"/>
        <button type="submit">Aplicar</button>
      </form>

      <form method="post" action="{{ '/admin/revoke_lifetime' if result.lifetime else '/admin/grant_lifetime' }}" style="display:flex; gap:8px; align-items:center;">
        <input type="hidden" name="owner_phone" value="{{ result.doc_id }}"/>
        {% if result.lifetime %}
          <button type="submit" style="background:#8a1e1e;">Revogar Vitalício</button>
          <span class="muted">Concessão vitalícia: <b>Concedido</b></span>
        {% else %}
          <button type="submit">Conceder Vitalício</button>
          <span class="muted">Concessão vitalícia: <b>Não concedido</b></span>
        {% endif %}
      </form>

      <details style="margin-top:12px;">
        <summary class="muted">Ver JSON bruto de billing</summary>
        <div class="raw">{{ s.billing_raw | tojson(indent=2) }}</div>
      </details>

      <!-- Admin Audit -->
      <h2>Histórico (Admin Audit)</h2>
      {% if result.admin_audit and result.admin_audit|length > 0 %}
        <div class="row" style="font-weight:600;"><div>Quando (ts)</div><div>Ação / Detalhes</div></div>
        {% for ev in result.admin_audit|sort(attribute='ts', reverse=True) %}
          <div class="row">
            <div>{{ ev.ts }}</div>
            <div>
              <b>{{ ev.action }}</b>
              {% if ev.admin %}<span class="muted">por {{ ev.admin }}</span>{% endif %}
              {% if ev.details %}<div class="muted">{{ ev.details | tojson(indent=0) }}</div>{% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="muted">Sem registros.</div>
      {% endif %}
    {% endif %}

    <p class="muted" style="margin-top:20px;">Logado como: {{ who }}</p>
  </div>
</body>
</html>
